module "Sessionhost" {
  source                         = "git::ssh://git@github.com/edfenergy/eit-azure-terraform-modules.git//azure-avd-sessionhost-vm"
  for_each                       = var.sessionhostType
  avd_Prefix                     = each.value.avd_Prefix
  avd_Location                   = each.value.avd_Location
  avd_ResourceGroup_Name         = each.value.avd_ResourceGroup_Name
  avd_Host_Count                 = each.value.avd_Host_Count
  avd_Subnet_Id                  = data.azurerm_subnet.avdSubnet[each.key].id
  avd_VM_size                    = each.value.avd_VM_size
  avd_LocalAdmin_Username        = data.azurerm_key_vault_secret.VM-userID[each.key].value
  avd_LocalAdmin_Password        = data.azurerm_key_vault_secret.VM-password[each.key].value
  avd_SharedImage_Id             = data.azurerm_key_vault_secret.VM-imageID[each.key].value
  avd_Disk_CashingType           = each.value.avd_Disk_CashingType
  zones                          = each.value.zones
  avd_OS_Disk_CreateOption       = each.value.avd_OS_Disk_CreateOption
  avd_OS_DiskType                = each.value.avd_OS_DiskType
  avd_Enable_BootDiagnostics     = each.value.avd_Enable_BootDiagnostics
  avd_BootDiagnostics_StorageUri = data.azurerm_storage_account.bootDiagLogStorage[each.key].primary_blob_endpoint
  Domain_Name                    = data.azurerm_key_vault_secret.Domain-Name[each.key].value
  avd_OU_path                    = data.azurerm_key_vault_secret.avd_OU_Path[each.key].value
  avd_DomainJoin_Username        = data.azurerm_key_vault_secret.Domain_Join_username[each.key].value
  avd_DomainJoin_Password        = data.azurerm_key_vault_secret.Domain_Join_Password[each.key].value
  resourceGroupName              = each.value.resourceGroupName
  hostPoolName                   = each.value.hostPoolName
  storageAccName                 = each.value.storageAccName
  storageKey                     = data.azurerm_key_vault_secret.storageKey[each.key].value
  storageContainerName           = each.value.storageContainerName
  spApplicationId                = data.azurerm_key_vault_secret.spApplicationId[each.key].value
  spSecret                       = data.azurerm_key_vault_secret.spSecret[each.key].value
  tenantId                       = data.azurerm_key_vault_secret.tenantId[each.key].value
  subscriptionId                 = data.azurerm_key_vault_secret.subscriptionId[each.key].value
  moduleUrl1                     = each.value.moduleUrl1
  moduleUrl2                     = each.value.moduleUrl2
  moduleUrl3                     = each.value.moduleUrl3
  KeyVaultURL                    = data.azurerm_key_vault.wvd_encryt_keyvault[each.key].vault_uri
  KeyVaultResourceId             = data.azurerm_key_vault.wvd_encryt_keyvault[each.key].id
  workspaceId                    = data.azurerm_key_vault_secret.LZ_workspaceID[each.key].value
  workspaceKey                   = data.azurerm_key_vault_secret.LZ_workspaceKey[each.key].value
  additionalTags                 = each.value.additionalTags
}
